using Barbara.Domain.Entities;
using Microsoft.EntityFrameworkCore;

namespace Barbara.Infrastructure.Data;

public class BarbaraDbContext : DbContext
{
  public BarbaraDbContext(DbContextOptions<BarbaraDbContext> options) : base(options)
    {
    }

    public DbSet<Cliente> Clientes { get; set; }
    public DbSet<Endereco> Enderecos { get; set; }
    public DbSet<Produto> Produtos { get; set; }
    public DbSet<Categoria> Categorias { get; set; }
    public DbSet<ImagemProduto> ImagensProdutos { get; set; }
    public DbSet<EstoqueProduto> EstoqueProdutos { get; set; }
    public DbSet<Pedido> Pedidos { get; set; }
    public DbSet<ItemPedido> ItensPedido { get; set; }
  public DbSet<Pagamento> Pagamentos { get; set; }
    public DbSet<NotaFiscal> NotasFiscais { get; set; }
    public DbSet<Envio> Envios { get; set; }
    public DbSet<Configuracao> Configuracoes { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        base.OnModelCreating(modelBuilder);

        // Cliente
        modelBuilder.Entity<Cliente>(entity =>
        {
       entity.HasKey(e => e.Id);
            entity.Property(e => e.Nome).IsRequired().HasMaxLength(200);
            entity.Property(e => e.Email).IsRequired().HasMaxLength(200);
          entity.Property(e => e.CPF).IsRequired().HasMaxLength(14);
    entity.Property(e => e.Altura).HasPrecision(5, 2);
            entity.Property(e => e.Peso).HasPrecision(5, 2);
            entity.HasIndex(e => e.Email).IsUnique();
          entity.HasIndex(e => e.CPF).IsUnique();
        });

        // Endereço
        modelBuilder.Entity<Endereco>(entity =>
        {
      entity.HasKey(e => e.Id);
      entity.Property(e => e.CEP).IsRequired().HasMaxLength(9);
            entity.Property(e => e.Logradouro).IsRequired().HasMaxLength(300);
    entity.Property(e => e.Cidade).IsRequired().HasMaxLength(100);
            entity.Property(e => e.Estado).IsRequired().HasMaxLength(2);
            entity.HasOne(e => e.Cliente)
 .WithMany(c => c.Enderecos)
             .HasForeignKey(e => e.ClienteId)
       .OnDelete(DeleteBehavior.Cascade);
      });

        // Categoria
        modelBuilder.Entity<Categoria>(entity =>
        {
        entity.HasKey(e => e.Id);
  entity.Property(e => e.Nome).IsRequired().HasMaxLength(100);
        });

        // Produto
        modelBuilder.Entity<Produto>(entity =>
   {
            entity.HasKey(e => e.Id);
            entity.Property(e => e.Nome).IsRequired().HasMaxLength(300);
 entity.Property(e => e.SKU).IsRequired().HasMaxLength(50);
  entity.Property(e => e.Preco).HasPrecision(18, 2);
            entity.Property(e => e.PrecoPromocional).HasPrecision(18, 2);
            entity.HasOne(e => e.Categoria)
            .WithMany(c => c.Produtos)
                .HasForeignKey(e => e.CategoriaId);
            entity.HasIndex(e => e.SKU).IsUnique();
});

        // Imagem Produto
        modelBuilder.Entity<ImagemProduto>(entity =>
        {
            entity.HasKey(e => e.Id);
            entity.HasOne(e => e.Produto)
    .WithMany(p => p.Imagens)
    .HasForeignKey(e => e.ProdutoId)
       .OnDelete(DeleteBehavior.Cascade);
 });

   // Estoque Produto
modelBuilder.Entity<EstoqueProduto>(entity =>
        {
      entity.HasKey(e => e.Id);
        entity.Property(e => e.Tamanho).IsRequired().HasMaxLength(10);
            entity.HasOne(e => e.Produto)
                .WithMany(p => p.Estoque)
        .HasForeignKey(e => e.ProdutoId)
        .OnDelete(DeleteBehavior.Cascade);
        });

        // Pedido
        modelBuilder.Entity<Pedido>(entity =>
        {
      entity.HasKey(e => e.Id);
        entity.Property(e => e.NumeroPedido).IsRequired().HasMaxLength(50);
    entity.Property(e => e.SubTotal).HasPrecision(18, 2);
          entity.Property(e => e.ValorFrete).HasPrecision(18, 2);
   entity.Property(e => e.Desconto).HasPrecision(18, 2);
entity.Property(e => e.Total).HasPrecision(18, 2);
      entity.HasOne(e => e.Cliente)
             .WithMany(c => c.Pedidos)
      .HasForeignKey(e => e.ClienteId);
      entity.HasOne(e => e.EnderecoEntrega)
         .WithMany()
      .HasForeignKey(e => e.EnderecoEntregaId)
                .OnDelete(DeleteBehavior.Restrict);
            entity.HasIndex(e => e.NumeroPedido).IsUnique();
        });

 // Item Pedido
 modelBuilder.Entity<ItemPedido>(entity =>
        {
            entity.HasKey(e => e.Id);
       entity.Property(e => e.PrecoUnitario).HasPrecision(18, 2);
   entity.Property(e => e.Subtotal).HasPrecision(18, 2);
   entity.HasOne(e => e.Pedido)
        .WithMany(p => p.Itens)
      .HasForeignKey(e => e.PedidoId)
         .OnDelete(DeleteBehavior.Cascade);
    entity.HasOne(e => e.Produto)
          .WithMany()
.HasForeignKey(e => e.ProdutoId)
  .OnDelete(DeleteBehavior.NoAction); // Mudado para NoAction
    entity.HasOne(e => e.EstoqueProduto)
     .WithMany()
           .HasForeignKey(e => e.EstoqueProdutoId)
        .OnDelete(DeleteBehavior.NoAction); // Mudado para NoAction
        });

 // Pagamento
modelBuilder.Entity<Pagamento>(entity =>
        {
  entity.HasKey(e => e.Id);
    entity.Property(e => e.Valor).HasPrecision(18, 2);
   entity.HasOne(e => e.Pedido)
 .WithOne(p => p.Pagamento)
      .HasForeignKey<Pagamento>(e => e.PedidoId)
     .OnDelete(DeleteBehavior.Cascade);
        });

        // Nota Fiscal
   modelBuilder.Entity<NotaFiscal>(entity =>
      {
            entity.HasKey(e => e.Id);
         entity.HasOne(e => e.Pedido)
       .WithOne(p => p.NotaFiscal)
    .HasForeignKey<NotaFiscal>(e => e.PedidoId)
     .OnDelete(DeleteBehavior.Cascade);
        });

        // Envio
        modelBuilder.Entity<Envio>(entity =>
  {
            entity.HasKey(e => e.Id);
        entity.Property(e => e.ValorFrete).HasPrecision(18, 2);
            entity.HasOne(e => e.Pedido)
     .WithOne(p => p.Envio)
       .HasForeignKey<Envio>(e => e.PedidoId)
        .OnDelete(DeleteBehavior.Cascade);
        });

 // Configuração
        modelBuilder.Entity<Configuracao>(entity =>
    {
            entity.HasKey(e => e.Id);
         entity.Property(e => e.Chave).IsRequired().HasMaxLength(100);
    entity.HasIndex(e => e.Chave).IsUnique();
     });
    }
}
